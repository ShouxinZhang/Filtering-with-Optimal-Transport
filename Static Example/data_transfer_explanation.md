# CPU â†” GPU æ•°æ®ä¼ è¾“å¼€é”€è¯¦è§£

## ğŸ—ï¸ ç¡¬ä»¶æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      PCIe æ€»çº¿       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CPU ç³»ç»Ÿ            â”‚   (~16-32 GB/s)      â”‚         GPU ç³»ç»Ÿ            â”‚
â”‚                             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚                             â”‚
â”‚  CPU å†…å­˜ (RAM)            â”‚                      â”‚   GPU å†…å­˜ (VRAM)          â”‚
â”‚  - å®¹é‡: 64GB              â”‚                      â”‚   - å®¹é‡: 16GB (5090)      â”‚
â”‚  - å¸¦å®½: ~50 GB/s          â”‚                      â”‚   - å¸¦å®½: ~1000 GB/s       â”‚
â”‚  - å»¶è¿Ÿ: è¾ƒä½               â”‚                      â”‚   - å»¶è¿Ÿ: æä½              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ æ•°æ®ä¼ è¾“ç¤ºä¾‹

### **é—®é¢˜ä»£ç  (é¢‘ç¹ä¼ è¾“):**

```python
# âŒ æ¯æ¬¡è¿­ä»£éƒ½ä¼ è¾“æ•°æ®
for i in range(1000):
    # 1. åœ¨CPUä¸Šç”Ÿæˆæ•°æ®
    X_cpu = torch.randn(1000, 2)  # CPUå†…å­˜
    Y_cpu = torch.randn(1000, 2)  # CPUå†…å­˜
    
    # 2. ä¼ è¾“åˆ°GPU (è€—æ—¶!)
    X_gpu = X_cpu.to('cuda')  # CPU â†’ GPU: ~0.1ms
    Y_gpu = Y_cpu.to('cuda')  # CPU â†’ GPU: ~0.1ms
    
    # 3. GPUè®¡ç®— (å¿«é€Ÿ)
    output = model(X_gpu, Y_gpu)  # GPU: 0.5ms
    loss = output.mean()
    
    # 4. ä¼ å›CPUæ‰“å° (è€—æ—¶!)
    print(f"Loss: {loss.item()}")  # GPU â†’ CPU: ~0.05ms
    
# æ€»æ—¶é—´ = 1000 Ã— (0.1 + 0.1 + 0.5 + 0.05) = 750ms
# å…¶ä¸­ä¼ è¾“å æ¯” = (0.1 + 0.1 + 0.05) / 0.75 = 33%
```

### **ä¼˜åŒ–ä»£ç  (å‡å°‘ä¼ è¾“):**

```python
# âœ… æ•°æ®ä¿æŒåœ¨GPUä¸Š
# 1. ä¸€æ¬¡æ€§ä¼ è¾“æ•°æ®åˆ°GPU
X_gpu = torch.randn(1000, 2, device='cuda')  # ç›´æ¥åœ¨GPUåˆ›å»º
Y_gpu = torch.randn(1000, 2, device='cuda')  # ç›´æ¥åœ¨GPUåˆ›å»º

for i in range(1000):
    # 2. å…¨ç¨‹åœ¨GPUè®¡ç®—
    output = model(X_gpu, Y_gpu)  # GPU: 0.5ms
    loss = output.mean()
    
    # 3. åªåœ¨éœ€è¦æ—¶æ‰ä¼ å›CPU
    if i % 100 == 0:
        print(f"Loss: {loss.item()}")  # æ¯100æ¬¡æ‰ä¼ ä¸€æ¬¡
    
# æ€»æ—¶é—´ = 1000 Ã— 0.5 + 10 Ã— 0.05 = 500.5ms
# ä¼ è¾“å æ¯”å¤§å¹…é™ä½!
```

## ğŸ“Š å®é™…ä»£ç ä¸­çš„ä¼ è¾“ç‚¹

### **1. è®­ç»ƒå¾ªç¯ä¸­çš„éšè—ä¼ è¾“**

```python
# static_example.py ç¬¬150è¡Œ
print("Iteration: %d/%d, loss = %.4f" %(i+1,ITERS,loss.item()))
#                                                      â†‘
#                                        è¿™é‡Œè§¦å‘ GPU â†’ CPU ä¼ è¾“!
```

**`loss.item()` åšäº†ä»€ä¹ˆ:**
```python
loss = torch.tensor([0.6552], device='cuda')
loss.item()  # å†…éƒ¨æ“ä½œ:
             # 1. GPUåŒæ­¥ (ç­‰å¾…æ‰€æœ‰GPUæ“ä½œå®Œæˆ)
             # 2. ä»GPUå†…å­˜å¤åˆ¶åˆ°CPUå†…å­˜
             # 3. è¿”å›Python float
```

### **2. å¯è§†åŒ–æ—¶çš„æ‰¹é‡ä¼ è¾“**

```python
# static_example.py ç¬¬238è¡Œ
plt.plot(X[:,0].detach().cpu().numpy(), ...)
#                        â†‘â†‘â†‘
#              è¿™é‡Œå‘ç”Ÿå¤§é‡æ•°æ®ä¼ è¾“!

# æ•°æ®æµ:
X (GPU) â†’ .detach() â†’ .cpu() â†’ .numpy()
         ä¿æŒåœ¨GPU   GPUâ†’CPU   è½¬ä¸ºNumPyæ•°ç»„
                    ä¼ è¾“æ•´ä¸ªæ•°ç»„!
```

## âš¡ ä¸ºä»€ä¹ˆå°æ¨¡å‹åœ¨CPUä¸Šæ›´å¿«?

### **GPU è®¡ç®—æµç¨‹å¼€é”€:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¯åŠ¨kernel  â”‚  æ•°æ®ä¼ è¾“   â”‚   GPUè®¡ç®—    â”‚  åŒæ­¥ç­‰å¾…   â”‚
â”‚   ~0.5ms     â”‚   ~0.2ms   â”‚    0.5ms    â”‚   ~0.1ms   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ€»è®¡: 1.3ms/iteration

CPUç›´æ¥è®¡ç®—: 0.8ms/iteration  â† æ›´å¿«!
```

### **GPUä¼˜åŠ¿çš„ä¸´ç•Œç‚¹:**

| æ•°æ®è§„æ¨¡        | Batch Size | CPUæ—¶é—´ | GPUæ—¶é—´ | èƒœè€… |
|----------------|-----------|---------|---------|-----|
| å° (N=1000)    | 128       | 8ms     | 21ms    | CPU |
| ä¸­ (N=10000)   | 512       | 80ms    | 50ms    | GPU |
| å¤§ (N=100000)  | 2048      | 800ms   | 100ms   | GPU |

## ğŸ¯ ä¼˜åŒ–å»ºè®®

### **1. å‡å°‘ `.item()` è°ƒç”¨**
```python
# âŒ æ¯æ¬¡è¿­ä»£éƒ½æ‰“å°
for i in range(ITERS):
    loss = compute_loss()
    print(loss.item())  # æ…¢!

# âœ… ç´¯ç§¯åæ‰¹é‡æ‰“å°
losses = []
for i in range(ITERS):
    loss = compute_loss()
    if i % 100 == 0:
        losses.append(loss.detach())  # ä¿æŒåœ¨GPU
if len(losses) > 0:
    print([l.item() for l in losses])  # æ‰¹é‡ä¼ è¾“
```

### **2. ä½¿ç”¨ TensorBoard è€Œéå®æ—¶æ‰“å°**
```python
from torch.utils.tensorboard import SummaryWriter
writer = SummaryWriter()

for i in range(ITERS):
    loss = compute_loss()
    writer.add_scalar('Loss/train', loss, i)  # å¼‚æ­¥å†™å…¥
```

### **3. å¢åŠ  Batch Size**
```python
# å°batch: GPUæ— æ³•å……åˆ†åˆ©ç”¨
BATCH_SIZE = 128  # åˆ©ç”¨ç‡: ~20%

# å¤§batch: GPUæ»¡è½½
BATCH_SIZE = 2048  # åˆ©ç”¨ç‡: ~80%
```

## ğŸ“ˆ åŸºå‡†æµ‹è¯•æ”¹è¿›å»ºè®®

```python
# å½“å‰é—®é¢˜: 1000æ¬¡è¿­ä»£å¤ªå°‘ï¼Œä¼ è¾“å¼€é”€å ä¸»å¯¼
# å»ºè®®æµ‹è¯•:
iterations_list = [1000, 5000, 10000, 20000]
batch_sizes = [128, 512, 2048]

for iters in iterations_list:
    for bs in batch_sizes:
        cpu_time = benchmark('cpu', iters, bs)
        gpu_time = benchmark('cuda', iters, bs)
        print(f"Iters={iters}, BS={bs}, Speedup={cpu_time/gpu_time:.2f}x")
```

## ğŸ“ å…³é”®è¦ç‚¹

1. **GPUä¸æ˜¯ä¸‡èƒ½è¯** - å°æ•°æ®é‡æ—¶CPUå¯èƒ½æ›´å¿«
2. **ä¼ è¾“æˆæœ¬å¾ˆé«˜** - å°½é‡è®©æ•°æ®ç•™åœ¨GPUä¸Š
3. **æ‰¹é‡å¤„ç†æ˜¯å…³é”®** - å¢å¤§batch sizeæé«˜GPUåˆ©ç”¨ç‡
4. **åŒæ­¥å¼€é”€** - æ¯æ¬¡ `.item()` éƒ½ä¼šç­‰å¾…GPUå®Œæˆæ‰€æœ‰æ“ä½œ
5. **é€‚ç”¨åœºæ™¯** - GPUåœ¨å¤§è§„æ¨¡å¹¶è¡Œè®¡ç®—æ—¶æ‰æœ‰ä¼˜åŠ¿

## ğŸ’» ä½ çš„RTX 5090æœ€ä½³ä½¿ç”¨åœºæ™¯

âœ… **é€‚åˆGPU:**
- å¤§batchè®­ç»ƒ (BS â‰¥ 1024)
- å®Œæ•´çš„20000æ¬¡è¿­ä»£è®­ç»ƒ
- å¤šä¸ªå®éªŒå¹¶è¡Œè¿è¡Œ
- é«˜ç»´æ•°æ® (å›¾åƒã€é«˜ç»´çŠ¶æ€ç©ºé—´)

âŒ **ä¸é€‚åˆGPU (ç”¨CPUæ›´å¥½):**
- å°batchè°ƒè¯• (BS < 256)
- å°‘é‡è¿­ä»£æµ‹è¯• (< 1000)
- é¢‘ç¹æ‰“å°/å¯è§†åŒ–
- åºåˆ—åŒ–æ“ä½œå¤šçš„ä»£ç 
